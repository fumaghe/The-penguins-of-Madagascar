<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container-fluid">
    <div class="row vh-100">
        <!-- Contact List Column -->
        <div class="col-md-4 col-lg-3 bg-light border-right">
            <h3 class="mt-3">Contacts</h3>
            <input type="text" class="form-control mb-3" placeholder="Search...">
            <ul class="list-group" id="contact-list">
                {% for contact in contacts %}
                <li class="list-group-item contact-item" data-contact="{{ contact }}">
                    <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="30" alt="Avatar">
                    {{ contact }}
                </li>
                {% endfor %}
            </ul>
        </div>
        <!-- Chat Column -->
        <div class="col-md-8 col-lg-9">
            <div id="chat-container" class="d-none">
                <div class="d-flex align-items-center p-3 border-bottom">
                    <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="50" alt="Avatar">
                    <div class="ml-3">
                        <h5 id="chat-contact-name"></h5>
                        <small id="chat-contact-status">Last seen: 2 hours ago</small>
                    </div>
                </div>
                <div id="chat-messages" class="p-3 overflow-auto" style="height: 70vh;">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="input-group p-3 border-top">
                    <input type="text" id="message-input" class="form-control" placeholder="Enter text here...">
                    <div class="input-group-append">
                        <button id="send-message" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
            <div id="no-chat-selected" class="d-flex justify-content-center align-items-center h-100">
                <h3>Select a contact to start chatting</h3>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    $(document).ready(function() {
        var socket = io();

        // Handle contact click
        $('.contact-item').on('click', function() {
            var contact = $(this).data('contact');
            var username = '{{ username }}';
            $('#chat-contact-name').text(contact);
            $('#chat-container').removeClass('d-none');
            $('#no-chat-selected').addClass('d-none');

            // Join the room
            var room = getRoomName(username, contact);
            socket.emit('join', { username: username, room: room });

            // Load chat messages for the selected contact
            $.get('/chat/' + contact + '?username=' + username, function(data) {
                $('#chat-messages').html(data.messages.map(function(message) {
                    var msgClass = message.includes(username) ? 'text-right' : 'text-left';
                    return `<div class="${msgClass}">${message}</div>`;
                }).join(''));
            });
        });

        // Handle message send
        $('#send-message').on('click', function() {
            var message = $('#message-input').val();
            var contact = $('#chat-contact-name').text();
            var username = '{{ username }}';
            var room = getRoomName(username, contact);

            socket.emit('message', { room: room, message: message, username: username, contact: contact });
            $('#message-input').val('');
        });

        socket.on('message', function(data) {
            var msgClass = data.username === '{{ username }}' ? 'text-right' : 'text-left';
            $('#chat-messages').append(`<div class="${msgClass}">${data.timestamp} ${data.username}: ${data.message}</div>`);
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        });

        function getRoomName(user1, user2) {
            var participants = [user1, user2].sort();
            return participants[0] + '_' + participants[1];
        }
    });
</script>
</body>
</html>
