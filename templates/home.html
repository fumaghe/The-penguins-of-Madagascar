<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container-fluid">
    <div class="row vh-100">
        <!-- Contact List Column -->
        <div class="col-md-4 col-lg-3 bg-light border-right">
            <h3 class="mt-3">Contacts</h3>
            <button id="add-btn" class="btn btn-primary mb-2">Add</button>
            <button id="remove-btn" class="btn btn-danger mb-3">Remove</button>
            <ul class="list-group" id="contact-list">
                {% for contact in contacts %}
                <li class="list-group-item contact-item" data-contact="{{ contact }}">
                    <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="30" alt="Avatar">
                    {{ contact }}
                </li>
                {% endfor %}
            </ul>
            <hr>
            <h5>Do Not Disturb</h5>
            <input type="checkbox" id="dnd-checkbox" {{ 'checked' if dnd == 'true' else '' }}> Enable
            <hr>
            <button id="profile-btn" class="btn btn-secondary">Profile</button>
        </div>
        <!-- Chat Column -->
        <div class="col-md-8 col-lg-9 d-flex flex-column">
            <div id="chat-container" class="d-none flex-grow-1">
                <div class="d-flex align-items-center p-3 border-bottom">
                    <img id="chat-contact-avatar" src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="50" alt="Avatar">
                    <div class="ml-3">
                        <h5 id="chat-contact-name"></h5>
                        <small id="chat-contact-status">Last seen: 2 hours ago</small>
                    </div>
                </div>
                <div id="chat-messages" class="p-3 overflow-auto flex-grow-1">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="input-group p-3 border-top">
                    <input type="text" id="message-input" class="form-control" placeholder="Enter text here...">
                    <div class="input-group-append">
                        <button id="send-message" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
            <div id="no-chat-selected" class="d-flex justify-content-center align-items-center flex-grow-1">
                <h3>Select a contact to start chatting</h3>
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profile-modal" tabindex="-1" role="dialog" aria-labelledby="profile-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profile-modal-label">Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form" method="post" action="/profile" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="new-username">New Username</label>
                        <input type="text" class="form-control" id="new-username" name="new_username">
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" class="form-control" id="new-password" name="new_password">
                    </div>
                    <div class="form-group">
                        <label for="avatar">Avatar</label>
                        <input type="file" class="form-control" id="avatar" name="avatar">
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        var socket = io();
        var username = '{{ username }}';

        // Handle contact click
        $('.contact-item').on('click', function() {
            var contact = $(this).data('contact');
            $('#chat-contact-name').text(contact);
            $('#chat-contact-avatar').attr('src', '{{ url_for("static", filename="avatar.png") }}'); // You can customize this line to load different avatars
            $('#chat-container').removeClass('d-none');
            $('#no-chat-selected').addClass('d-none');

            // Join the room
            var room = getRoomName(username, contact);
            socket.emit('join', { username: username, room: room });

            // Load chat messages for the selected contact
            $.get('/chat/' + contact, function(data) {
                $('#chat-messages').html(data.messages.map(function(message) {
                    var msgClass = message.sender === username ? 'sent-message' : 'received-message';
                    var msgTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="${msgClass}">
                            <div class="message-content">${message.text}</div>
                            <div class="message-timestamp">${msgTime}</div>
                        </div>
                    `;
                }).join(''));
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            });
        });

        // Handle message send
        $('#send-message').on('click', function() {
            var message = $('#message-input').val();
            var contact = $('#chat-contact-name').text();
            var room = getRoomName(username, contact);

            socket.emit('message', { room: room, message: message, username: username, contact: contact });
            $('#message-input').val('');
        });

        socket.on('message', function(data) {
            if (data.error) {
                alert(data.error);
                return;
            }
            var msgClass = data.username === username ? 'sent-message' : 'received-message';
            var msgTime = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            $('#chat-messages').append(`
                <div class="${msgClass}">
                    <div class="message-content">${data.message}</div>
                    <div class="message-timestamp">${msgTime}</div>
                </div>
            `);
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        });

        // Handle Add Contact
        $('#add-btn').on('click', function() {
            var newContact = prompt("Enter the username of the contact to add:");
            if (newContact) {
                $.post('/add_contact', { new_contact: newContact }, function(data) {
                    if (data.status === "success") {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        // Handle Remove Contact
        $('#remove-btn').on('click', function() {
            var contactToRemove = prompt("Enter the username of the contact to remove:");
            if (contactToRemove) {
                $.post('/remove_contact', { contact_to_remove: contactToRemove }, function() {
                    location.reload();
                });
            }
        });

        // Handle DND
        $('#dnd-checkbox').on('change', function() {
            var dnd = $(this).is(':checked');
            $.post('/toggle_dnd', { dnd: dnd });
        });

        // Handle Profile
        $('#profile-btn').on('click', function() {
            $('#profile-modal').modal('show');
        });

        function getRoomName(user1, user2) {
            var participants = [user1, user2].sort();
            return participants[0] + '_' + participants[1];
        }
    });
</script>
<style>
    .sent-message, .received-message {
        max-width: 60%;
        margin: 5px 0;
        padding: 10px;
        border-radius: 10px;
        word-wrap: break-word;
        display: inline-block;
    }
    .sent-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        align-self: flex-end;
    }
    .received-message {
        background-color: #f8f9fa;
        border: 1px solid #dae0e5;
        align-self: flex-start;
    }
    .message-timestamp {
        font-size: 0.8em;
        text-align: right;
    }
    #chat-messages {
        overflow-y: auto;
    }
    #profile-modal .form-group {
        margin-bottom: 15px;
    }
</style>
</body>
</html>
