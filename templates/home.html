<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://use.fontawesome.com/1c6f725ec5.js"></script>
</head>
<body>
    <div class="green-background"></div>
    <div class="wrap">
        <section class="left">
            <div class="profile">
                <img src="{{ url_for('static', filename='avatar.png') }}">
                <div class="icons">
                    <i class="fa fa-commenting fa-lg" aria-hidden="true"></i>
                    <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
                </div>
            </div>
            <div class="wrap-search">
                <div class="search">
                    <i class="fa fa-search fa" aria-hidden="true"></i>
                    <input type="text" class="input-search" placeholder="Search or start new chat">
                </div>
            </div>
            <div class="contact-list">
                <ul class="list-group" id="contact-list">
                    {% for contact in contacts %}
                    <li class="contact list-group-item contact-item" data-contact="{{ contact }}">
                        <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="50" alt="Avatar">
                        <div class="contact-preview">
                            <div class="contact-text">
                                <h1 class="font-name">{{ contact }}</h1>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </section>
        <section class="right">
            <div class="chat-head">
                <img src="{{ url_for('static', filename='avatar.png') }}">
                <div class="chat-name">
                    <h1 class="font-name" id="chat-contact-name">Select a contact</h1>
                    <p class="font-online" id="chat-contact-status"></p>
                </div>
                <i class="fa fa-search fa-lg" aria-hidden="true"></i>
                <i class="fa fa-paperclip fa-lg" aria-hidden="true"></i>
                <i class="fa fa-bars fa-lg" aria-hidden="true" id="show-contact-information"></i>
                <i class="fa fa-times fa-lg" aria-hidden="true" id="close-contact-information"></i>
            </div>
            <div class="wrap-chat">
                <div class="chat" id="chat-window">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="wrap-message">
                    <i class="fa fa-smile-o fa-lg" aria-hidden="true"></i>
                    <div class="message">
                        <input type="text" class="input-message" id="message-input" placeholder="Enter text here...">
                    </div>
                    <i class="fa fa-microphone fa-lg" aria-hidden="true"></i>
                </div>
            </div>
        </section>
    </div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        var socket = io();
        var username = '{{ username }}';

        // Handle contact click
        $('.contact-item').on('click', function() {
            var contact = $(this).data('contact');
            $('#chat-contact-name').text(contact);
            $('#chat-contact-status').text('Loading...');

            // Join the room
            var room = getRoomName(username, contact);
            socket.emit('join', { username: username, room: room });

            // Load chat messages for the selected contact
            $.get('/chat/' + contact, function(data) {
                $('#chat-window').html(data.messages.map(function(message) {
                    var msgClass = message.username === username ? 'me' : 'you';
                    return `
                        <div class="chat-bubble ${msgClass}">
                            <div class="${msgClass === 'me' ? 'my-mouth' : 'your-mouth'}"></div>
                            <div class="content">
                                ${message.message}
                            </div>
                            <div class="time">
                                ${message.timestamp}
                            </div>
                        </div>`;
                }).join(''));
                $('#chat-contact-status').text('');
                $('#chat-window').scrollTop($('#chat-window')[0].scrollHeight);
            });
        });

        // Handle message send
        $('#message-input').on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                var message = $('#message-input').val();
                var contact = $('#chat-contact-name').text();
                var room = getRoomName(username, contact);

                if (contact !== 'Select a contact') {
                    socket.emit('message', { room: room, message: message, username: username, contact: contact });
                    $('#message-input').val('');
                }
            }
        });

        socket.on('message', function(data) {
            var msgClass = data.username === username ? 'me' : 'you';
            $('#chat-window').append(`
                <div class="chat-bubble ${msgClass}">
                    <div class="${msgClass === 'me' ? 'my-mouth' : 'your-mouth'}"></div>
                    <div class="content">
                        ${data.message}
                    </div>
                    <div class="time">
                        ${data.timestamp}
                    </div>
                </div>`);
            $('#chat-window').scrollTop($('#chat-window')[0].scrollHeight);
        });

        function getRoomName(user1, user2) {
            var participants = [user1, user2].sort();
            return participants[0] + '_' + participants[1];
        }
    });
</script>
</body>
</html>