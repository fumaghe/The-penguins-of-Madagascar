<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Chat Messages */
        .chat-messages {
            background: url('{{ url_for('static', filename='sfondo.png') }}') no-repeat center center fixed;
            background-size: cover;
            padding-bottom: 60px;
            height: calc(100vh - 160px);
            overflow-y: auto;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row vh-100">
        <!-- Sidebar -->
        <div class="col-3 sidebar">
            <h1>Whatsup</h1>
            <h3>Contacts</h3>
            <div class="btn-group mb-3">
                <button id="add-btn" class="btn btn-primary">Add</button>
                <button id="remove-btn" class="btn btn-danger">Remove</button>
            </div>
            <ul class="list-group" id="contact-list">
                {% for contact in contacts %}
                <li class="list-group-item contact-item" data-contact="{{ contact }}">
                    <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="30" alt="Avatar">
                    {{ contact }}
                </li>
                {% endfor %}
            </ul>
            <hr>
            <h5>Do Not Disturb</h5>
            <label class="switch">
                <input type="checkbox" id="dnd-checkbox" {{ 'checked' if dnd == 'true' else '' }}>
                <span class="slider"></span>
            </label>
            <hr>
            <button id="profile-btn" class="btn btn-secondary">Profile</button>
            <button id="search-btn" class="btn btn-secondary">Search Users</button>
        </div>

        <!-- Chat Column -->
        <div class="col-9 d-flex flex-column" style="margin-left: 320px;">
            <div id="chat-container" class="flex-grow-1 d-flex flex-column">
                <!-- Chat Head -->
                <div class="chat-head d-flex align-items-center p-3 border-bottom">
                    <img src="{{ url_for('static', filename='avatar.png') }}" class="rounded-circle" width="50" alt="Avatar">
                    <div class="ml-3">
                        <h5 class="chat-contact-name" id="chat-contact-name"></h5>
                        <small class="chat-contact-status" id="chat-contact-status">Last seen: 2 hours ago</small>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="chat-messages p-3 overflow-auto flex-grow-1">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Chat Input -->
                <div class="input-group-container">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type something here...">
                        <div class="input-group-append">
                            <button id="send-message" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profile-modal" tabindex="-1" role="dialog" aria-labelledby="profile-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profile-modal-label">Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form" method="post" action="/profile" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="new-username">New Username</label>
                        <input type="text" class="form-control" id="new-username" name="new_username">
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" class="form-control" id="new-password" name="new_password">
                    </div>
                    <div class="form-group">
                        <label for="avatar">Avatar</label>
                        <input type="file" class="form-control" id="avatar" name="avatar">
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal fade" id="search-modal" tabindex="-1" role="dialog" aria-labelledby="search-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="search-modal-label">Search Users</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="search-form" method="post" action="/search">
                    <div class="form-group">
                        <label for="search_query">Nome Utente (parziale)</label>
                        <input type="text" class="form-control" id="search_query" name="search_query" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Cerca</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        var socket = io();
        var username = '{{ username }}';

        // Handle contact click
        $('.contact-item').on('click', function() {
            var contact = $(this).data('contact');
            $('#chat-contact-name').text(contact);

            // Join the room
            var room = getRoomName(username, contact);
            socket.emit('join', { username: username, room: room });

            // Load chat messages for the selected contact
            $.get('/chat/' + contact, function(data) {
                $('#chat-messages').html(data.messages.map(function(message) {
                    var msgClass = message.sender === username ? 'sent-message' : 'received-message';
                    return '<div class="' + msgClass + '">' + message.text + '<span class="message-timestamp">' + message.timestamp + '</span></div>';
                }).join(''));
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            });
        });

        // Handle message send
        $('#send-message').on('click', function() {
            var message = $('#message-input').val();
            var contact = $('#chat-contact-name').text();
            var room = getRoomName(username, contact);

            socket.emit('message', { room: room, message: message, username: username, contact: contact });
            $('#message-input').val('');
        });

        $('#message-input').keypress(function(e) {
            if (e.which == 13) { // Enter key pressed
                $('#send-message').click(); // Trigger send button click event
            }
        });

        socket.on('message', function(data) {
            if (data.error) {
                alert(data.error);
                return;
            }
            var msgClass = data.username === username ? 'sent-message' : 'received-message';
            $('#chat-messages').append('<div class="' + msgClass + '">' + data.message + '<span class="message-timestamp">' + data.timestamp + '</span></div>');
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        });

        // Handle Add Contact
        $('#add-btn').on('click', function() {
            var newContact = prompt("Enter the username of the contact to add:");
            if (newContact) {
                $.post('/add_contact', { new_contact: newContact }, function(data) {
                    if (data.status === "success") {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        // Handle Remove Contact
        $('#remove-btn').on('click', function() {
            var contactToRemove = prompt("Enter the username of the contact to remove:");
            if (contactToRemove) {
                $.post('/remove_contact', { contact_to_remove: contactToRemove }, function() {
                    location.reload();
                });
            }
        });

        // Handle DND
        $('#dnd-checkbox').on('change', function() {
            var dnd = $(this).is(':checked');
            $.post('/toggle_dnd', { dnd: dnd });
        });

        // Handle Profile
        $('#profile-btn').on('click', function() {
            $('#profile-modal').modal('show');
        });

        // Handle Search
        $('#search-btn').on('click', function() {
            $('#search-modal').modal('show');
        });

        function getRoomName(user1, user2) {
            var participants = [user1, user2].sort();
            return participants[0] + '_' + participants[1];
        }
    });
</script>
</body>
</html>
